<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>c-base - Unauthoritative member statistics</title>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//code.highcharts.com/highcharts.js"></script>
<script src="//code.highcharts.com/modules/data.js"></script>
<script src="//code.highcharts.com/modules/exporting.js"></script>
</head>
<body>
<div id="container" style="width: 100%; margin: 0 auto"></div>
<div id="pie" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>

<script type="text/javascript">
$(document).ready(function() {
  var options = {
    title: {
      text: 'c-base members'
    },
    subtitle: {
      text: 'Unauthoritative statistics'
    },
    xAxis: {
      gridLineWidth: 1,
      type: 'datetime'
    },
    yAxis: {
      gridLineWidth: 1,
      min: 0
    },
    chart: {
      renderTo: 'container',
      type: 'area'
    },
    tooltip: {
      shared: true,
      formatter: function() {
        var s = '<b>' + Highcharts.dateFormat("%b %Y", this.x, true) + '</b>';
        $.each(this.points, function () {
          s += '<br/>' + this.series.name + ': ' +this.y + ' Members';
        });
        return s;
      }
    },
    plotOptions: {
      area: {
        stacking: 'normal',
        marker: {
          enabled: false
        }
      }
    },
    series: [{name: 'Members'}]
  };
  var pieoptions = {
    chart: {
      plotBackgroundColor: null,
      plotBorderWidth: null,
      plotShadow: false,
      renderTo: 'pie',
      type: 'pie'
    },
    title: {
      text: 'c-base members (today)'
    },
    subtitle: {
      text: 'Unauthoritative statistics'
    },
    plotOptions: {
      pie: {
        dataLabels: {
          enabled: true,
          format: '<b>{point.name}</b>: {point.percentage:.1f}% ({point.y})',
        }
      }
    }
  };

  $.ajax({
    dataType: "json",
    url: 'https://vorstand.c-base.org/cteward-api/legacy/stats/contracts?callback=?',
    success: function(data) {
      var today = new Date();
      var series = {};
      var pieseries = {};
      for (var i=0; i < data.length; i++) {
        if (data[i].Year > today.getFullYear() || (data[i].Year == today.getFullYear() && data[i].Month > today.getMonth()+1))
          continue;
        if (data[i].Year == today.getFullYear() && data[i].Month == today.getMonth()+1)
          for (var j=0; j < data[i].Contracts.length; j++) {
            pieseries[data[i].Contracts[j].Type] = data[i].Contracts[j].Count;
          }
        for (var j=0; j < data[i].Contracts.length; j++) {
          if (data[i].Contracts[j].Type in series) {
            series[data[i].Contracts[j].Type].data.push([ (new Date(data[i].Year, data[i].Month, 28)).getTime(), data[i].Contracts[j].Count]);
          } else {
            series[data[i].Contracts[j].Type] = {
              name: data[i].Contracts[j].Type,
              data: [[ (new Date(data[i].Year, data[i].Month, 28)).getTime(), data[i].Contracts[j].Count]]
            }
          }
        }
      }
      options.series = [];
      series_keys = Object.keys(series).sort()
      if (series_keys.length == 8)
        series_keys = [
          "Firmenmitglied",
          "Member (Megaförder)",
          "Member (Förder)",
          "Member (Regulär)",
          "Member (Sozial)",
          "Member (Sonder)",
          "Member (Ruhend)",
          "Fördermitglied",
        ];
      for (var i=0; i < series_keys.length; i++) {
        options.series.push(series[series_keys[i]]);
      }
      console.log(options);
      var chart = new Highcharts.Chart(options);

      pieoptions.series = [{ type: 'pie', name: 'Contracts', data: [] }]
      pieseries_keys = Object.keys(series).sort()
      if (pieseries_keys.length == 8)
        pieseries_keys = [
          "Firmenmitglied",
          "Member (Megaförder)",
          "Member (Förder)",
          "Member (Regulär)",
          "Member (Sozial)",
          "Member (Sonder)",
          "Member (Ruhend)",
          "Fördermitglied",
        ];
      for (var i=0; i < pieseries_keys.length; i++) {
        if (pieseries[pieseries_keys[i]])
          pieoptions.series[0].data.push([ pieseries_keys[i], pieseries[pieseries_keys[i]]]);
        else
          pieoptions.series[0].data.push([ pieseries_keys[i], 0]);
      }
      console.log(pieseries);
      console.log(pieoptions);
      var pie = new Highcharts.Chart(pieoptions);
    }
    });
});
</script>
</body>
</html>
